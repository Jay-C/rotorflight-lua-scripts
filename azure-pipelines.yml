# Builds the Rotorflight TX lua scripts.
#
# After building, artifacts are released to a seperate repository.
#
# Azure Pipelines requires the following extensions to be installed:
# - GitHub Tool: https://marketplace.visualstudio.com/items?itemName=marcelo-formentao.github-tools
#
# You'll also need to setup the follwing pipeline variables: 
#     "releaseNotes" - This is used to add the release notes in the windows job in the build stage so they can be published as part of the github release in the release stage
#     "endpoint" - The name of the github endpoint link setup in AzDo - setup when linking AzDo and GitHub
#     "owner" - The owner of the repository to release to e.g. rotorflight
#     "repoName" - The name of the repository to release to e.g. rotorflight-configurator-nightly

variables:
  owner: rotorflight
  repoName: rotorflight-opentx-lua
  releaseNotes: Rotorflight OpenTX Lua scripts.
  vmImage: 'ubuntu-20.04'

name: $(Date:yyyyMMdd).$(BuildID)

trigger:
  batch: true
  branches:
    include:
    - master

pr:
  drafts: false
  branches:
    include:
    - master
    - "*-maintenance"

stages:
- stage: Build
  jobs:
  - job: 'Linux'
    pool:
      vmImage: '$(vmImage)'
    steps:
    - script: sudo apt-get -y install lua5.2
      displayName: 'Install lua compiler.'
    - script: make release -C $(System.DefaultWorkingDirectory)
      displayName: 'Test and build the release.'
    - task: PublishPipelineArtifact@1
      displayName: 'Publish release'
      inputs: 
        artifactName: rotorflight-opentx-lua
        targetPath: '$(System.DefaultWorkingDirectory)/release'

- stage: Release
  jobs:
  - job: Release
    pool:
      vmImage: '$(vmImage)'
    steps:
    - task: DownloadPipelineArtifact@2
      inputs:
        buildType: 'current'
        targetPath: '$(Pipeline.Workspace)'
    - task: GitHubReleasePublish@1
      inputs:
        githubEndpoint: '$(endpoint)'
        manuallySetRepository: true
        githubOwner: '$(owner)'
        githubRepositoryName: '$(repoName)'
        githubReleaseNotes: |+
          $(releaseNotes)

          ### Changes:
          $(Build.SourceVersionMessage)
        githubReleaseDraft: false
        githubReleasePrerelease: false
        githubIgnoreAssets: false
        githubReleaseAsset: |
          $(Pipeline.Workspace)/rotorflight-opentx-lua/**
        githubReuseRelease: true
        githubReuseDraftOnly: true
        githubSkipDuplicatedAssets: false
        githubEditRelease: false
        githubDeleteEmptyTag: false
